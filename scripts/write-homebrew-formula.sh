#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 2 ]]; then
  echo "Usage: $0 <version-tag> <sha256> [repo]" >&2
  echo "Example: $0 v0.1.0 0123abcd... gracefish/codex-history-manager" >&2
  exit 1
fi

version_tag="$1"
sha256_value="$2"
repo="${3:-gracefish/codex-history-manager}"

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
project_root="$(cd "$script_dir/.." && pwd)"
formula_path="$project_root/packaging/homebrew/codex-history.rb"

cat > "$formula_path" <<FORMULA
class CodexHistory < Formula
  desc "Local batch manager for Codex conversation history"
  homepage "https://github.com/${repo}"
  url "https://github.com/${repo}/archive/refs/tags/${version_tag}.tar.gz"
  sha256 "${sha256_value}"
  license "MIT"

  depends_on "node"

  def install
    libexec.install Dir["*"]

    (bin/"codex-history").write <<~SH
      #!/usr/bin/env bash
      exec "#{Formula["node"].opt_bin}/node" "#{libexec}/src/cli.js" "$@"
    SH
  end

  test do
    assert_match "codex-history", shell_output("#{bin}/codex-history --help")
  end
end
FORMULA

echo "Wrote formula to: $formula_path"
